---
apiVersion: v1
kind: Namespace
metadata:
  name: kube-upgrade
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.19.0
  name: kubeupgradeplans.kubeupgrade.heathcliff.eu
spec:
  group: kubeupgrade.heathcliff.eu
  names:
    kind: KubeUpgradePlan
    listKind: KubeUpgradePlanList
    plural: kubeupgradeplans
    shortNames:
    - plan
    singular: kubeupgradeplan
  scope: Cluster
  versions:
  - additionalPrinterColumns:
    - description: The targeted kubernetes version
      jsonPath: .spec.kubernetesVersion
      name: Version
      type: string
    - description: A summary of the overall status of the cluster
      jsonPath: .status.summary
      name: Status
      type: string
    name: v1alpha3
    schema:
      openAPIV3Schema:
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            properties:
              allowDowngrade:
                default: false
                description: |-
                  Allow downgrading to older kubernetes versions.
                  Only enable if you know what you are doing.
                type: boolean
              groups:
                additionalProperties:
                  properties:
                    dependsOn:
                      description: |-
                        Specify group(s) that should be upgraded first.
                        Should be used to ensure control-plane nodes are upgraded first.
                      example: control-plane
                      items:
                        type: string
                      type: array
                      x-kubernetes-list-type: atomic
                    labels:
                      additionalProperties:
                        type: string
                      description: The labels by which to filter nodes for this group
                      example: node-role.kubernetes.io/control-plane;node-role.kubernetes.io/compute
                      type: object
                    tolerations:
                      description: Enable the upgraded pods to be scheduled on tainted
                        nodes like control-planes.
                      items:
                        description: |-
                          The pod this Toleration is attached to tolerates any taint that matches
                          the triple <key,value,effect> using the matching operator <operator>.
                        properties:
                          effect:
                            description: |-
                              Effect indicates the taint effect to match. Empty means match all taint effects.
                              When specified, allowed values are NoSchedule, PreferNoSchedule and NoExecute.
                            type: string
                          key:
                            description: |-
                              Key is the taint key that the toleration applies to. Empty means match all taint keys.
                              If the key is empty, operator must be Exists; this combination means to match all values and all keys.
                            type: string
                          operator:
                            description: |-
                              Operator represents a key's relationship to the value.
                              Valid operators are Exists and Equal. Defaults to Equal.
                              Exists is equivalent to wildcard for value, so that a pod can
                              tolerate all taints of a particular category.
                            type: string
                          tolerationSeconds:
                            description: |-
                              TolerationSeconds represents the period of time the toleration (which must be
                              of effect NoExecute, otherwise this field is ignored) tolerates the taint. By default,
                              it is not set, which means tolerate the taint forever (do not evict). Zero and
                              negative values will be treated as 0 (evict immediately) by the system.
                            format: int64
                            type: integer
                          value:
                            description: |-
                              Value is the taint value the toleration matches to.
                              If the operator is Exists, the value should be empty, otherwise just a regular string.
                            type: string
                        type: object
                      type: array
                      x-kubernetes-list-type: atomic
                    upgraded:
                      description: The configuration for all upgraded daemons in the
                        group. Overwrites global parameters.
                      nullable: true
                      properties:
                        allowUnsignedOstreeImages:
                          description: Allow unsigned ostree images for rebase. It
                            is recommended to use signed images instead.
                          type: boolean
                        checkInterval:
                          description: The interval between regular checks
                          example: 3h;24h;30m
                          format: go-duration
                          type: string
                        fleetlockGroup:
                          description: The group to use for fleetlock
                          example: control-plane;compute
                          type: string
                        fleetlockUrl:
                          description: URL for the fleetlock server. Is required to
                            be set globally.
                          example: https://fleetlock.example.com
                          type: string
                        kubeadmPath:
                          description: The path to the kubeadm binary on the node.
                            Upgraded will download kubeadm if no path is provided.
                          example: /usr/bin/kubeadm
                          type: string
                        kubeletConfig:
                          description: The path to the kubelet config file on the
                            node
                          example: /etc/kubernetes/kubelet.conf
                          type: string
                        logLevel:
                          description: The log level used by slog, default "info"
                          enum:
                          - debug
                          - info
                          - warn
                          - error
                          example: debug;info;warn;error
                          type: string
                        retryInterval:
                          description: The interval between retries when an operation
                            fails
                          example: 5m;1m;30s
                          format: go-duration
                          type: string
                        stream:
                          description: The container image repository for os rebases
                          example: ghcr.io/heathcliff26/fcos-k8s
                          type: string
                      type: object
                  required:
                  - labels
                  type: object
                description: |-
                  The different groups in which the nodes will be upgraded.
                  At minimum needs to separate control-plane from compute nodes, to ensure that control-plane nodes will be upgraded first.
                minProperties: 1
                type: object
              kubernetesVersion:
                description: |-
                  The kubernetes version the cluster should be at.
                  If the actual version differs, the cluster will be upgraded.
                example: v1.31.0
                type: string
              upgraded:
                description: The configuration for all upgraded daemons. Can be overwritten
                  by group specific config.
                properties:
                  allowUnsignedOstreeImages:
                    description: Allow unsigned ostree images for rebase. It is recommended
                      to use signed images instead.
                    type: boolean
                  checkInterval:
                    description: The interval between regular checks
                    example: 3h;24h;30m
                    format: go-duration
                    type: string
                  fleetlockGroup:
                    description: The group to use for fleetlock
                    example: control-plane;compute
                    type: string
                  fleetlockUrl:
                    description: URL for the fleetlock server. Is required to be set
                      globally.
                    example: https://fleetlock.example.com
                    type: string
                  kubeadmPath:
                    description: The path to the kubeadm binary on the node. Upgraded
                      will download kubeadm if no path is provided.
                    example: /usr/bin/kubeadm
                    type: string
                  kubeletConfig:
                    description: The path to the kubelet config file on the node
                    example: /etc/kubernetes/kubelet.conf
                    type: string
                  logLevel:
                    description: The log level used by slog, default "info"
                    enum:
                    - debug
                    - info
                    - warn
                    - error
                    example: debug;info;warn;error
                    type: string
                  retryInterval:
                    description: The interval between retries when an operation fails
                    example: 5m;1m;30s
                    format: go-duration
                    type: string
                  stream:
                    description: The container image repository for os rebases
                    example: ghcr.io/heathcliff26/fcos-k8s
                    type: string
                type: object
            required:
            - groups
            - kubernetesVersion
            - upgraded
            type: object
          status:
            properties:
              groups:
                additionalProperties:
                  type: string
                description: The current status of each group
                type: object
              summary:
                description: A summary of the overall status of the cluster
                type: string
            type: object
        required:
        - spec
        type: object
    served: true
    storage: true
    subresources:
      status: {}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: kube-upgrade
  namespace: kube-upgrade
  labels:
    app.kubernetes.io/name: kube-upgrade
    app.kubernetes.io/instance: kube-upgrade
    app.kubernetes.io/version: "latest"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: kube-upgrade
  labels:
    app.kubernetes.io/name: kube-upgrade
    app.kubernetes.io/instance: kube-upgrade
    app.kubernetes.io/version: "latest"
rules:
- apiGroups:
  - ""
  resources:
  - nodes
  verbs:
  - list
  - update
  - watch
- apiGroups:
  - kubeupgrade.heathcliff.eu
  resources:
  - kubeupgradeplans
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - kubeupgrade.heathcliff.eu
  resources:
  - kubeupgradeplans/status
  verbs:
  - get
  - patch
  - update
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kube-upgrade
  labels:
    app.kubernetes.io/name: kube-upgrade
    app.kubernetes.io/instance: kube-upgrade
    app.kubernetes.io/version: "latest"
subjects:
  - kind: ServiceAccount
    name: kube-upgrade
    namespace: kube-upgrade
roleRef:
  kind: ClusterRole
  name: kube-upgrade
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: kube-upgrade
  labels:
    app.kubernetes.io/name: kube-upgrade
    app.kubernetes.io/instance: kube-upgrade
    app.kubernetes.io/version: "latest"
  namespace: kube-upgrade
rules:
- apiGroups:
  - ""
  resources:
  - configmaps
  verbs:
  - create
  - delete
  - list
  - update
  - watch
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - create
  - patch
- apiGroups:
  - apps
  resources:
  - daemonsets
  verbs:
  - create
  - delete
  - list
  - update
  - watch
- apiGroups:
  - coordination.k8s.io
  resources:
  - leases
  verbs:
  - create
  - get
  - update
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: kube-upgrade
  namespace: kube-upgrade
  labels:
    app.kubernetes.io/name: kube-upgrade
    app.kubernetes.io/instance: kube-upgrade
    app.kubernetes.io/version: "latest"
subjects:
  - kind: ServiceAccount
    name: kube-upgrade
roleRef:
  kind: Role
  name: kube-upgrade
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: v1
kind: Service
metadata:
  name: kube-upgrade-webhooks
  namespace: kube-upgrade
  labels:
    app.kubernetes.io/name: kube-upgrade
    app.kubernetes.io/instance: kube-upgrade
    app.kubernetes.io/version: "latest"
spec:
  type: ClusterIP
  ipFamilyPolicy: PreferDualStack
  ports:
    - port: 443
      protocol: TCP
      targetPort: 9443
  selector:
    app.kubernetes.io/name: kube-upgrade
    app.kubernetes.io/instance: kube-upgrade
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kube-upgrade
  namespace: kube-upgrade
  labels:
    app.kubernetes.io/name: kube-upgrade
    app.kubernetes.io/instance: kube-upgrade
    app.kubernetes.io/version: "latest"
spec:
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: kube-upgrade
      app.kubernetes.io/instance: kube-upgrade
  template:
    metadata:
      labels:
        app.kubernetes.io/name: kube-upgrade
        app.kubernetes.io/instance: kube-upgrade
        app.kubernetes.io/version: "latest"
    spec:
      serviceAccountName: kube-upgrade
      containers:
        - name: upgrade-controller
          image: "ghcr.io/heathcliff26/kube-upgrade-controller:latest"
          imagePullPolicy: IfNotPresent
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: UPGRADED_IMAGE
              value: ghcr.io/heathcliff26/kube-upgraded
            - name: UPGRADED_TAG
              value: latest
          ports:
            - name: probe
              containerPort: 9090
              protocol: TCP
            - name: webhook-server
              containerPort: 9443
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /healthz
              port: probe
            initialDelaySeconds: 5
            periodSeconds: 1
            successThreshold: 1
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /readyz
              port: probe
            initialDelaySeconds: 5
            periodSeconds: 1
          resources:
            requests:
              cpu: 2m
              memory: 32Mi
          volumeMounts:
            - name: cert
              mountPath: /tmp/k8s-webhook-server/serving-certs
              readOnly: true
      volumes:
        - name: cert
          secret:
            defaultMode: 420
            secretName: kube-upgrade-webhook-cert
---
# yaml-language-server: $schema=https://kubernetes-schemas.heathcliff.eu/cert-manager.io/certificate_v1.json
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: kube-upgrade-webhook-cert
  namespace: kube-upgrade
  labels:
    app.kubernetes.io/name: kube-upgrade
    app.kubernetes.io/instance: kube-upgrade
    app.kubernetes.io/version: "latest"
spec:
  dnsNames:
  - "kube-upgrade-webhooks.kube-upgrade.svc"
  - "kube-upgrade-webhooks.kube-upgrade.svc.cluster.local"
  issuerRef:
    kind: Issuer
    name: kube-upgrade-selfsigned
  secretName: kube-upgrade-webhook-cert
---
# yaml-language-server: $schema=https://kubernetes-schemas.heathcliff.eu/cert-manager.io/issuer_v1.json
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: kube-upgrade-selfsigned
  namespace: kube-upgrade
  labels:
    app.kubernetes.io/name: kube-upgrade
    app.kubernetes.io/instance: kube-upgrade
    app.kubernetes.io/version: "latest"
spec:
  selfSigned: {}
---
apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  name: kube-upgrade-webhook
  annotations:
    cert-manager.io/inject-ca-from: kube-upgrade/kube-upgrade-webhook-cert
  labels:
    app.kubernetes.io/name: kube-upgrade
    app.kubernetes.io/instance: kube-upgrade
    app.kubernetes.io/version: "latest"
webhooks:
  - admissionReviewVersions:
      - v1
    clientConfig:
      service:
        name: kube-upgrade-webhooks
        namespace: kube-upgrade
        path: /mutate-kubeupgrade-heathcliff-eu-v1alpha3-kubeupgradeplan
    failurePolicy: Fail
    name: kubeupgrade.heathcliff.eu
    rules:
      - apiGroups:
          - kubeupgrade.heathcliff.eu
        apiVersions:
          - v1alpha3
        operations:
          - CREATE
          - UPDATE
        resources:
          - kubeupgradeplans
    sideEffects: None
---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: kube-upgrade-webhook
  annotations:
    cert-manager.io/inject-ca-from: kube-upgrade/kube-upgrade-webhook-cert
  labels:
    app.kubernetes.io/name: kube-upgrade
    app.kubernetes.io/instance: kube-upgrade
    app.kubernetes.io/version: "latest"
webhooks:
  - admissionReviewVersions:
      - v1
    clientConfig:
      service:
        name: kube-upgrade-webhooks
        namespace: kube-upgrade
        path: /validate-kubeupgrade-heathcliff-eu-v1alpha3-kubeupgradeplan
    failurePolicy: Fail
    name: kubeupgrade.heathcliff.eu
    rules:
      - apiGroups:
          - kubeupgrade.heathcliff.eu
        apiVersions:
          - v1alpha3
        operations:
          - CREATE
          - UPDATE
        resources:
          - kubeupgradeplans
    sideEffects: None
