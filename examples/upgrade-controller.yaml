---
apiVersion: v1
kind: Namespace
metadata:
  name: kube-upgrade
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.19.0
  name: kubeupgradeplans.kubeupgrade.heathcliff.eu
spec:
  group: kubeupgrade.heathcliff.eu
  names:
    kind: KubeUpgradePlan
    listKind: KubeUpgradePlanList
    plural: kubeupgradeplans
    shortNames:
    - plan
    singular: kubeupgradeplan
  scope: Cluster
  versions:
  - additionalPrinterColumns:
    - description: The targeted kubernetes version
      jsonPath: .spec.kubernetesVersion
      name: Version
      type: string
    - description: A summary of the overall status of the cluster
      jsonPath: .status.summary
      name: Status
      type: string
    deprecated: true
    deprecationWarning: v1alpha1 is deprecated and will be removed in a future release.
      Please use v1alpha3 instead.
    name: v1alpha1
    schema:
      openAPIV3Schema:
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            properties:
              groups:
                additionalProperties:
                  properties:
                    dependsOn:
                      description: |-
                        Specify group(s) that should be upgraded first.
                        Should be used to ensure control-plane nodes are upgraded first.
                      example: control-plane
                      items:
                        type: string
                      type: array
                    labels:
                      additionalProperties:
                        type: string
                      description: The labels by which to filter for this group
                      example: node-role.kubernetes.io/control-plane;node-role.kubernetes.io/compute
                      minProperties: 1
                      type: object
                    upgraded:
                      description: The configuration for all upgraded daemons in the
                        group. Overwrites global parameters.
                      nullable: true
                      properties:
                        check-interval:
                          description: The interval between regular checks
                          example: 3h;24h;30m
                          format: duration
                          type: string
                        fleetlock-group:
                          description: The group to use for fleetlock
                          example: control-plane;compute
                          type: string
                        fleetlock-url:
                          description: URL for the fleetlock server. Needs to be set
                            either globally or for each node
                          example: https://fleetlock.example.com
                          type: string
                        retry-interval:
                          description: The interval between retries when an operation
                            fails
                          example: 5m;1m;30s
                          format: duration
                          type: string
                        stream:
                          description: The container image repository for os rebases
                          example: ghcr.io/heathcliff26/fcos-k8s
                          type: string
                      type: object
                  required:
                  - labels
                  type: object
                description: |-
                  The different groups in which the nodes will be upgraded.
                  At minimum needs to separate control-plane from compute nodes, to ensure that control-plane nodes will be upgraded first.
                minProperties: 1
                type: object
              kubernetesVersion:
                description: |-
                  The kubernetes version the cluster should be at.
                  If the actual version differs, the cluster will be upgraded
                example: v1.31.0
                pattern: ^v[0-9]+\.[0-9]+\.[0-9]+$
                type: string
              upgraded:
                description: The configuration for all upgraded daemons. Can be overwritten
                  by group specific config.
                nullable: true
                properties:
                  check-interval:
                    description: The interval between regular checks
                    example: 3h;24h;30m
                    format: duration
                    type: string
                  fleetlock-group:
                    description: The group to use for fleetlock
                    example: control-plane;compute
                    type: string
                  fleetlock-url:
                    description: URL for the fleetlock server. Needs to be set either
                      globally or for each node
                    example: https://fleetlock.example.com
                    type: string
                  retry-interval:
                    description: The interval between retries when an operation fails
                    example: 5m;1m;30s
                    format: duration
                    type: string
                  stream:
                    description: The container image repository for os rebases
                    example: ghcr.io/heathcliff26/fcos-k8s
                    type: string
                type: object
            required:
            - groups
            - kubernetesVersion
            type: object
          status:
            properties:
              groups:
                additionalProperties:
                  type: string
                description: The current status of each group
                type: object
              summary:
                description: A summary of the overall status of the cluster
                enum:
                - Unknown
                - Waiting
                - Progressing
                - Complete
                type: string
            type: object
        required:
        - spec
        type: object
    served: true
    storage: false
    subresources:
      status: {}
  - additionalPrinterColumns:
    - description: The targeted kubernetes version
      jsonPath: .spec.kubernetesVersion
      name: Version
      type: string
    - description: A summary of the overall status of the cluster
      jsonPath: .status.summary
      name: Status
      type: string
    deprecated: true
    deprecationWarning: v1alpha2 is deprecated and will be removed in a future release.
      Please use v1alpha3 instead.
    name: v1alpha2
    schema:
      openAPIV3Schema:
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            properties:
              allowDowngrade:
                default: false
                description: |-
                  Allow downgrading to older kubernetes versions.
                  Only enable if you know what you are doing.
                type: boolean
              groups:
                additionalProperties:
                  properties:
                    dependsOn:
                      description: |-
                        Specify group(s) that should be upgraded first.
                        Should be used to ensure control-plane nodes are upgraded first.
                      example: control-plane
                      items:
                        type: string
                      type: array
                      x-kubernetes-list-type: atomic
                    labels:
                      description: The label selector by which to filter for this
                        group
                      example: node-role.kubernetes.io/control-plane;node-role.kubernetes.io/compute
                      properties:
                        matchExpressions:
                          description: matchExpressions is a list of label selector
                            requirements. The requirements are ANDed.
                          items:
                            description: |-
                              A label selector requirement is a selector that contains values, a key, and an operator that
                              relates the key and values.
                            properties:
                              key:
                                description: key is the label key that the selector
                                  applies to.
                                type: string
                              operator:
                                description: |-
                                  operator represents a key's relationship to a set of values.
                                  Valid operators are In, NotIn, Exists and DoesNotExist.
                                type: string
                              values:
                                description: |-
                                  values is an array of string values. If the operator is In or NotIn,
                                  the values array must be non-empty. If the operator is Exists or DoesNotExist,
                                  the values array must be empty. This array is replaced during a strategic
                                  merge patch.
                                items:
                                  type: string
                                type: array
                                x-kubernetes-list-type: atomic
                            required:
                            - key
                            - operator
                            type: object
                          type: array
                          x-kubernetes-list-type: atomic
                        matchLabels:
                          additionalProperties:
                            type: string
                          description: |-
                            matchLabels is a map of {key,value} pairs. A single {key,value} in the matchLabels
                            map is equivalent to an element of matchExpressions, whose key field is "key", the
                            operator is "In", and the values array contains only "value". The requirements are ANDed.
                          type: object
                      type: object
                      x-kubernetes-map-type: atomic
                    upgraded:
                      description: The configuration for all upgraded daemons in the
                        group. Overwrites global parameters.
                      nullable: true
                      properties:
                        check-interval:
                          description: The interval between regular checks
                          example: 3h;24h;30m
                          format: go-duration
                          type: string
                        fleetlock-group:
                          description: The group to use for fleetlock
                          example: control-plane;compute
                          type: string
                        fleetlock-url:
                          description: URL for the fleetlock server. Is required to
                            be set globally.
                          example: https://fleetlock.example.com
                          type: string
                        retry-interval:
                          description: The interval between retries when an operation
                            fails
                          example: 5m;1m;30s
                          format: go-duration
                          type: string
                        stream:
                          description: The container image repository for os rebases
                          example: ghcr.io/heathcliff26/fcos-k8s
                          type: string
                      type: object
                  required:
                  - labels
                  type: object
                description: |-
                  The different groups in which the nodes will be upgraded.
                  At minimum needs to separate control-plane from compute nodes, to ensure that control-plane nodes will be upgraded first.
                minProperties: 1
                type: object
              kubernetesVersion:
                description: |-
                  The kubernetes version the cluster should be at.
                  If the actual version differs, the cluster will be upgraded.
                example: v1.31.0
                type: string
              upgraded:
                description: The configuration for all upgraded daemons. Can be overwritten
                  by group specific config.
                properties:
                  check-interval:
                    description: The interval between regular checks
                    example: 3h;24h;30m
                    format: go-duration
                    type: string
                  fleetlock-group:
                    description: The group to use for fleetlock
                    example: control-plane;compute
                    type: string
                  fleetlock-url:
                    description: URL for the fleetlock server. Is required to be set
                      globally.
                    example: https://fleetlock.example.com
                    type: string
                  retry-interval:
                    description: The interval between retries when an operation fails
                    example: 5m;1m;30s
                    format: go-duration
                    type: string
                  stream:
                    description: The container image repository for os rebases
                    example: ghcr.io/heathcliff26/fcos-k8s
                    type: string
                type: object
            required:
            - groups
            - kubernetesVersion
            - upgraded
            type: object
          status:
            properties:
              groups:
                additionalProperties:
                  type: string
                description: The current status of each group
                type: object
              summary:
                description: A summary of the overall status of the cluster
                type: string
            type: object
        required:
        - spec
        type: object
    served: true
    storage: false
    subresources:
      status: {}
  - additionalPrinterColumns:
    - description: The targeted kubernetes version
      jsonPath: .spec.kubernetesVersion
      name: Version
      type: string
    - description: A summary of the overall status of the cluster
      jsonPath: .status.summary
      name: Status
      type: string
    name: v1alpha3
    schema:
      openAPIV3Schema:
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            properties:
              allowDowngrade:
                default: false
                description: |-
                  Allow downgrading to older kubernetes versions.
                  Only enable if you know what you are doing.
                type: boolean
              groups:
                additionalProperties:
                  properties:
                    dependsOn:
                      description: |-
                        Specify group(s) that should be upgraded first.
                        Should be used to ensure control-plane nodes are upgraded first.
                      example: control-plane
                      items:
                        type: string
                      type: array
                      x-kubernetes-list-type: atomic
                    labels:
                      additionalProperties:
                        type: string
                      description: The labels by which to filter nodes for this group
                      example: node-role.kubernetes.io/control-plane;node-role.kubernetes.io/compute
                      type: object
                    tolerations:
                      description: Enable the upgraded pods to be scheduled on tainted
                        nodes like control-planes.
                      items:
                        description: |-
                          The pod this Toleration is attached to tolerates any taint that matches
                          the triple <key,value,effect> using the matching operator <operator>.
                        properties:
                          effect:
                            description: |-
                              Effect indicates the taint effect to match. Empty means match all taint effects.
                              When specified, allowed values are NoSchedule, PreferNoSchedule and NoExecute.
                            type: string
                          key:
                            description: |-
                              Key is the taint key that the toleration applies to. Empty means match all taint keys.
                              If the key is empty, operator must be Exists; this combination means to match all values and all keys.
                            type: string
                          operator:
                            description: |-
                              Operator represents a key's relationship to the value.
                              Valid operators are Exists and Equal. Defaults to Equal.
                              Exists is equivalent to wildcard for value, so that a pod can
                              tolerate all taints of a particular category.
                            type: string
                          tolerationSeconds:
                            description: |-
                              TolerationSeconds represents the period of time the toleration (which must be
                              of effect NoExecute, otherwise this field is ignored) tolerates the taint. By default,
                              it is not set, which means tolerate the taint forever (do not evict). Zero and
                              negative values will be treated as 0 (evict immediately) by the system.
                            format: int64
                            type: integer
                          value:
                            description: |-
                              Value is the taint value the toleration matches to.
                              If the operator is Exists, the value should be empty, otherwise just a regular string.
                            type: string
                        type: object
                      type: array
                      x-kubernetes-list-type: atomic
                    upgraded:
                      description: The configuration for all upgraded daemons in the
                        group. Overwrites global parameters.
                      nullable: true
                      properties:
                        checkInterval:
                          description: The interval between regular checks
                          example: 3h;24h;30m
                          format: go-duration
                          type: string
                        fleetlockGroup:
                          description: The group to use for fleetlock
                          example: control-plane;compute
                          type: string
                        fleetlockUrl:
                          description: URL for the fleetlock server. Is required to
                            be set globally.
                          example: https://fleetlock.example.com
                          type: string
                        kubeadmPath:
                          description: The path to the kubeadm binary on the node
                          example: /usr/bin/kubeadm
                          type: string
                        kubeletConfig:
                          description: The path to the kubelet config file on the
                            node
                          example: /etc/kubernetes/kubelet.conf
                          type: string
                        logLevel:
                          description: The log level used by slog, default "info"
                          enum:
                          - debug
                          - info
                          - warn
                          - error
                          example: debug;info;warn;error
                          type: string
                        retryInterval:
                          description: The interval between retries when an operation
                            fails
                          example: 5m;1m;30s
                          format: go-duration
                          type: string
                        stream:
                          description: The container image repository for os rebases
                          example: ghcr.io/heathcliff26/fcos-k8s
                          type: string
                      type: object
                  required:
                  - labels
                  type: object
                description: |-
                  The different groups in which the nodes will be upgraded.
                  At minimum needs to separate control-plane from compute nodes, to ensure that control-plane nodes will be upgraded first.
                minProperties: 1
                type: object
              kubernetesVersion:
                description: |-
                  The kubernetes version the cluster should be at.
                  If the actual version differs, the cluster will be upgraded.
                example: v1.31.0
                type: string
              upgraded:
                description: The configuration for all upgraded daemons. Can be overwritten
                  by group specific config.
                properties:
                  checkInterval:
                    description: The interval between regular checks
                    example: 3h;24h;30m
                    format: go-duration
                    type: string
                  fleetlockGroup:
                    description: The group to use for fleetlock
                    example: control-plane;compute
                    type: string
                  fleetlockUrl:
                    description: URL for the fleetlock server. Is required to be set
                      globally.
                    example: https://fleetlock.example.com
                    type: string
                  kubeadmPath:
                    description: The path to the kubeadm binary on the node
                    example: /usr/bin/kubeadm
                    type: string
                  kubeletConfig:
                    description: The path to the kubelet config file on the node
                    example: /etc/kubernetes/kubelet.conf
                    type: string
                  logLevel:
                    description: The log level used by slog, default "info"
                    enum:
                    - debug
                    - info
                    - warn
                    - error
                    example: debug;info;warn;error
                    type: string
                  retryInterval:
                    description: The interval between retries when an operation fails
                    example: 5m;1m;30s
                    format: go-duration
                    type: string
                  stream:
                    description: The container image repository for os rebases
                    example: ghcr.io/heathcliff26/fcos-k8s
                    type: string
                type: object
            required:
            - groups
            - kubernetesVersion
            - upgraded
            type: object
          status:
            properties:
              groups:
                additionalProperties:
                  type: string
                description: The current status of each group
                type: object
              summary:
                description: A summary of the overall status of the cluster
                type: string
            type: object
        required:
        - spec
        type: object
    served: true
    storage: true
    subresources:
      status: {}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: upgrade-controller
  namespace: kube-upgrade
  labels:
    app: upgrade-controller
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: upgrade-controller
rules:
- apiGroups:
  - ""
  resources:
  - nodes
  verbs:
  - list
  - update
- apiGroups:
  - kubeupgrade.heathcliff.eu
  resources:
  - kubeupgradeplans
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - kubeupgrade.heathcliff.eu
  resources:
  - kubeupgradeplans/status
  verbs:
  - get
  - patch
  - update
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: upgrade-controller
  namespace: kube-upgrade
  labels:
    app: upgrade-controller
subjects:
  - kind: ServiceAccount
    name: upgrade-controller
    namespace: kube-upgrade
roleRef:
  kind: ClusterRole
  name: upgrade-controller
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: upgrade-controller
  namespace: kube-upgrade
  labels:
    app: upgrade-controller
rules:
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "patch"]
  - apiGroups: ["coordination.k8s.io"]
    resources: ["leases"]
    verbs: ["create", "get", "update"]
  - apiGroups: ["apps"]
    resources: ["daemonsets"]
    verbs: ["list", "watch", "create", "update", "delete"]
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["list", "watch", "create", "update", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: upgrade-controller
  namespace: kube-upgrade
subjects:
  - kind: ServiceAccount
    name: upgrade-controller
roleRef:
  kind: Role
  name: upgrade-controller
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: selfsigned
  namespace: kube-upgrade
  labels:
    app: upgrade-controller
spec:
  selfSigned: {}
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: webhook-server-cert
  namespace: kube-upgrade
  labels:
    app: upgrade-controller
spec:
  dnsNames:
  - upgrade-controller-webhooks.kube-upgrade.svc
  - upgrade-controller-webhooks.kube-upgrade.svc.cluster.local
  issuerRef:
    kind: Issuer
    name: selfsigned
  secretName: webhook-server-cert
---
apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  name: kube-upgrade-webhook
  annotations:
    cert-manager.io/inject-ca-from: kube-upgrade/webhook-server-cert
webhooks:
  - admissionReviewVersions:
      - v1
    clientConfig:
      service:
        name: upgrade-controller-webhooks
        namespace: kube-upgrade
        path: /mutate-kubeupgrade-heathcliff-eu-v1alpha3-kubeupgradeplan
    failurePolicy: Fail
    name: kubeupgrade.heathcliff.eu
    rules:
      - apiGroups:
          - kubeupgrade.heathcliff.eu
        apiVersions:
          - v1alpha3
        operations:
          - CREATE
          - UPDATE
        resources:
          - kubeupgradeplans
    sideEffects: None
---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: kube-upgrade-webhook
  annotations:
    cert-manager.io/inject-ca-from: kube-upgrade/webhook-server-cert
webhooks:
  - admissionReviewVersions:
      - v1
    clientConfig:
      service:
        name: upgrade-controller-webhooks
        namespace: kube-upgrade
        path: /validate-kubeupgrade-heathcliff-eu-v1alpha3-kubeupgradeplan
    failurePolicy: Fail
    name: kubeupgrade.heathcliff.eu
    rules:
      - apiGroups:
          - kubeupgrade.heathcliff.eu
        apiVersions:
          - v1alpha3
        operations:
          - CREATE
          - UPDATE
        resources:
          - kubeupgradeplans
    sideEffects: None
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: upgrade-controller
  namespace: kube-upgrade
  labels:
    app: upgrade-controller
spec:
  replicas: 2
  selector:
    matchLabels:
      app: upgrade-controller
  template:
    metadata:
      labels:
        app: upgrade-controller
    spec:
      serviceAccountName: upgrade-controller
      containers:
        - name: upgrade-controller
          image: ghcr.io/heathcliff26/kube-upgrade-controller:latest
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: UPGRADED_IMAGE
              value: ghcr.io/heathcliff26/kube-upgraded
            - name: UPGRADED_TAG
              value: latest
          ports:
            - name: probe
              containerPort: 9090
              protocol: TCP
            - name: webhook-server
              containerPort: 9443
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /healthz
              port: probe
            initialDelaySeconds: 5
            periodSeconds: 1
            successThreshold: 1
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /readyz
              port: probe
            initialDelaySeconds: 5
            periodSeconds: 1
          volumeMounts:
            - name: cert
              mountPath: /tmp/k8s-webhook-server/serving-certs
              readOnly: true
      volumes:
        - name: cert
          secret:
            defaultMode: 420
            secretName: webhook-server-cert
---
apiVersion: v1
kind: Service
metadata:
  name: upgrade-controller-webhooks
  namespace: kube-upgrade
  labels:
    app: upgrade-controller
spec:
  ports:
    - port: 443
      protocol: TCP
      targetPort: 9443
  selector:
    app: upgrade-controller
